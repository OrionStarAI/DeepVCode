# 自适应高度优化 - 测试指南

## 🎯 核心逻辑

### 执行状态分离策略

```typescript
// 执行中（Executing）：限制高度，避免闪烁
if (status === ToolCallStatus.Executing && availableHeight !== undefined) {
  return <MaxSizedBox maxHeight={availableHeight}>...</MaxSizedBox>
}

// 执行完成（Success/Error）：显示完整内容
else {
  return <Text wrap="wrap">...</Text>
}
```

**好处**：
- ✅ **执行中**：自适应限制高度，布局稳定，无闪烁
- ✅ **执行完成**：显示完整内容，用户可以查看所有输出

---

## 📋 测试场景

### 场景 1：小窗口流式输出

**步骤**：
```bash
# 1. 调整终端到小窗口
printf '\e[8;25;80t'

# 2. 启动 CLI
npm run dev

# 3. 执行 ping 命令
!ping -c 20 8.8.8.8
```

**预期结果**：

| 阶段 | 显示效果 | 验证点 |
|------|----------|--------|
| **执行中** | ✅ 显示最新 13-20 行<br>✅ 显示 "... first N lines hidden ..." | 1. 无闪烁<br>2. 高度限制生效 |
| **执行完成** | ✅ 显示完整 20+ 行输出<br>❌ 没有 "hidden" 提示 | 1. 内容完整<br>2. 可以滚动查看所有内容 |

### 场景 2：中窗口流式输出

**步骤**：
```bash
# 1. 调整终端到中窗口
printf '\e[8;40;100t'

# 2. 执行 ping 命令
!ping -c 20 8.8.8.8
```

**预期结果**：

| 阶段 | 显示效果 |
|------|----------|
| **执行中** | ✅ 显示最新 20-29 行 |
| **执行完成** | ✅ 显示完整内容（约 22 行） |

### 场景 3：大窗口流式输出

**步骤**：
```bash
# 1. 调整终端到大窗口
printf '\e[8;60;200t'

# 2. 执行 ping 命令
!ping -c 20 8.8.8.8
```

**预期结果**：

| 阶段 | 显示效果 |
|------|----------|
| **执行中** | ✅ 显示所有内容（Shell 命令限制 20 行） |
| **执行完成** | ✅ 显示完整内容 |

---

## 🔍 关键验证点

### 1. 执行中的高度限制

**验证方法**：
1. 执行 `!ping -c 20 8.8.8.8`
2. **在输出过程中**观察界面
3. 应该看到 `... first N lines hidden ...` 提示（小窗口）
4. 界面应该**完全稳定**，无闪烁

**✅ 通过标准**：
- 高度限制生效（显示 hidden 提示）
- 完全无闪烁
- 始终显示最新内容

### 2. 执行完成的完整显示

**验证方法**：
1. 等待 ping 命令执行完成
2. 观察最终输出
3. **不应该**看到 `... first N lines hidden ...` 提示
4. 所有 20+ 行输出都应该可见

**✅ 通过标准**：
- 无 hidden 提示
- 内容完整（包括统计信息）
- 可以向上滚动查看所有内容

### 3. 动态调整响应

**验证方法**：
```bash
# 1. 小窗口执行
printf '\e[8;25;80t'
!ping -c 20 8.8.8.8

# 2. 观察执行中的高度限制（~13-20 行）

# 3. 等待完成，观察完整输出

# 4. 调整到大窗口
printf '\e[8;60;200t'

# 5. 再次执行
!ping -c 20 8.8.8.8

# 6. 观察是否自适应调整
```

**✅ 通过标准**：
- 小窗口：执行中限制高度，完成后显示完整
- 大窗口：执行中限制高度（20 行），完成后显示完整
- 窗口调整后，高度自动重新计算

---

## 🎨 视觉效果对比

### 执行中（小窗口 80x25）

```
┌─ shell 输出（高度限制：~13 行）─┐
│ ... first 9 lines hidden ...    │  ← MaxSizedBox 截断
│ 64 bytes from ... (seq=10)      │
│ 64 bytes from ... (seq=11)      │
│ ...                             │
│ 64 bytes from ... (seq=20)      │  ← 流式更新中
└──────────────────────────────────┘
✅ 无闪烁，布局稳定
```

### 执行完成（小窗口 80x25）

```
64 bytes from ... (seq=1)
64 bytes from ... (seq=2)
...
64 bytes from ... (seq=20)
--- 8.8.8.8 ping statistics ---
20 packets transmitted, 20 received
✅ 完整内容，无截断
```

---

## ⚠️ 已知限制

### 1. Shell 命令最大高度

**限制**：执行中最大显示 20 行（`ToolGroupMessage.tsx` 中设置）

**原因**：
- Shell 命令通常是单个工具调用
- 避免分配过多高度导致内容稀疏
- 20 行对大部分 shell 输出足够

**影响**：
- ✅ 大部分场景（如 ping 20 次）：正常
- ⚠️ 特殊场景（如 `ls -la /usr/bin`）：执行中可能截断
- ✅ 执行完成后：显示完整内容

### 2. 自适应高度分级

**小窗口（≤30 行）**：
- 执行中：最大 ~13-20 行
- 完成后：完整显示

**中窗口（31-50 行）**：
- 执行中：最大 ~20-29 行
- 完成后：完整显示

**大窗口（>50 行）**：
- 执行中：最大 20 行（Shell 命令限制）
- 完成后：完整显示

---

## 🐛 故障排查

### 问题 1：执行完成后仍然显示 "hidden"

**原因**：`status` 没有正确更新为 `Success`

**检查**：
```typescript
// shellCommandProcessor.ts 中确认
setPendingHistoryItem(null); // 清空 pending
addToGeminiHistory({
  type: 'tool_group',
  tools: [{
    status: ToolCallStatus.Success, // ← 确保是 Success
    resultDisplay: finalOutput,
    ...
  }]
});
```

### 问题 2：小窗口下执行完成后仍然闪烁

**原因**：可能是其他组件（如输入框边框）导致

**检查**：
1. 输入框边框是否在执行完成后显示（应该显示）
2. ToolGroupMessage 边框是否仍然隐藏（Shell 命令应该隐藏）

### 问题 3：大窗口下执行中高度过小

**原因**：Shell 命令限制了 20 行上限

**调整**（如果需要）：
```typescript
// ToolGroupMessage.tsx
const maxHeightForSingleTool = isShellCommand
  ? 30  // 从 20 调整到 30
  : Math.floor(availableTerminalHeight * 0.8);
```

---

## ✅ 验证清单

测试前准备：
- [ ] 代码已编译（`npm run build`）
- [ ] CLI 已启动（`npm run dev`）
- [ ] 终端窗口可以调整大小

功能验证：
- [ ] **小窗口（80x25）**：
  - [ ] 执行中显示 hidden 提示
  - [ ] 执行中完全无闪烁
  - [ ] 执行完成后显示完整内容
- [ ] **中窗口（100x40）**：
  - [ ] 执行中高度限制合理
  - [ ] 执行完成后显示完整内容
- [ ] **大窗口（200x60）**：
  - [ ] 执行中高度限制（20 行）
  - [ ] 执行完成后显示完整内容
- [ ] **动态调整**：
  - [ ] 窗口大小变化时自动适应

边界场景：
- [ ] 超长输出（`ls -la /usr/bin`）：执行完成后完整显示
- [ ] 短输出（`echo "test"`）：执行中和完成后一致
- [ ] 连续执行多个命令：每个都正确处理

---

## 📝 测试记录模板

```markdown
### 测试日期：____年__月__日

#### 环境
- 操作系统：macOS / Linux / Windows
- 终端类型：iTerm2 / Terminal.app / VS Code Terminal
- 终端大小：___x___

#### 测试结果

| 场景 | 执行中 | 执行完成 | 通过/失败 | 备注 |
|------|--------|----------|-----------|------|
| 小窗口 ping | | | | |
| 中窗口 ping | | | | |
| 大窗口 ping | | | | |
| 超长输出 | | | | |
| 动态调整 | | | | |

#### 问题记录
-

#### 结论
- [ ] 通过所有测试
- [ ] 发现问题，需要修复
```

---

## 🚀 提交前检查

在提交代码前，请确保：

1. **功能验证**：
   - [ ] 小窗口无闪烁
   - [ ] 执行完成后显示完整内容
   - [ ] 动态调整正常工作

2. **代码质量**：
   - [ ] 编译通过（`npm run build`）
   - [ ] Linter 无错误
   - [ ] 注释清晰

3. **文档完善**：
   - [ ] 测试结果已记录
   - [ ] 已知问题已说明

---

**测试完成后，请告知结果，我们再决定是否提交！** 🎯
