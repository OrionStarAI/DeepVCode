# DeepV Code Hooks æ¶æ„è®¾è®¡è¯´æ˜

> æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ Hooks ç³»ç»Ÿå¦‚ä½•åœ¨ `packages/core` ä¸­å®ç°ï¼Œä»¥åŠå®ƒå¦‚ä½•è¢«æ‰€æœ‰å®¢æˆ·ç«¯è‡ªåŠ¨ç»§æ‰¿çš„æ¶æ„è®¾è®¡ã€‚

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     packages/core (æ ¸å¿ƒåŠŸèƒ½åº“)               â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  AI Client & Model Interaction       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Tool System & Execution Engine      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  MCP Engine (Context Management)     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ğŸ¯ Hooks System (NEW)              â”‚  â”‚
â”‚  â”‚  â”œâ”€ HookRegistry                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ HookPlanner                      â”‚  â”‚
â”‚  â”‚  â”œâ”€ HookRunner                       â”‚  â”‚
â”‚  â”‚  â”œâ”€ HookAggregator                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ HookEventHandler (11 events)     â”‚  â”‚
â”‚  â”‚  â””â”€ HookSystem (Coordinator)         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†‘                      â†‘
        â”‚ ä¾èµ–               â”‚ ä¾èµ–
        â”‚                      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ CLI     â”‚          â”‚ VSCode UI Plugin â”‚
    â”‚ Package â”‚          â”‚ Package          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†‘                      â†‘
        â”‚ è‡ªåŠ¨äº«å—            â”‚ è‡ªåŠ¨äº«å—
        â”‚ Hooks èƒ½åŠ›          â”‚ Hooks èƒ½åŠ›
        â”‚                      â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
           æœ€ç»ˆç”¨æˆ·
```

## ğŸ“¦ é¡¹ç›®ç»“æ„

```
DeepVCode/
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ hooks/                    â† Hooks ç³»ç»Ÿæ ¸å¿ƒ
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ types.ts              (ç±»å‹å®šä¹‰)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ hookRegistry.ts       (é…ç½®åŠ è½½)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ hookPlanner.ts        (æ‰§è¡Œè®¡åˆ’)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ hookRunner.ts         (è„šæœ¬æ‰§è¡Œ)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ hookAggregator.ts     (ç»“æœèšåˆ)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ hookEventHandler.ts   (äº‹ä»¶å¤„ç†)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ hookSystem.ts         (åè°ƒå™¨)
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts              (å¯¼å‡º)
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ config.ts             â† æ›´æ–°ï¼šæ”¯æŒ hooks getter
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ debugLogger.ts        (æ—¥å¿—å·¥å…·)
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”œâ”€â”€ tools/                    (å…¶ä»–ç³»ç»Ÿ...)
â”‚   â”‚   â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â”œâ”€â”€ cli/
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ ...
â”‚   â”‚   â”‚   â””â”€â”€ services/
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â”‚   â””â”€â”€ dependencies: {
â”‚   â”‚   â”‚       "deepv-code-core": "file:../core"  â† ä¾èµ– core
â”‚   â”‚   â”‚     }
â”‚   â”‚   â””â”€â”€ dist/
â”‚   â”‚
â”‚   â””â”€â”€ vscode-ui-plugin/
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ extension.ts               (å¯¼å…¥ deepv-code-core)
â”‚       â”‚   â”œâ”€â”€ services/
â”‚       â”‚   â”‚   â”œâ”€â”€ authManager.ts         (å¯¼å…¥ core)
â”‚       â”‚   â”‚   â”œâ”€â”€ aiService.ts           (å¯¼å…¥ core)
â”‚       â”‚   â”‚   â””â”€â”€ ...
â”‚       â”‚   â””â”€â”€ ...
â”‚       â”‚
â”‚       â”œâ”€â”€ package.json
â”‚       â”‚   â””â”€â”€ dependencies: {
â”‚       â”‚       æ²¡æœ‰æ˜¾å¼çš„ deepv-code-core  â† ä½†é€šè¿‡ import ä½¿ç”¨ core
â”‚       â”‚     }
â”‚       â””â”€â”€ dist/
â”‚
â””â”€â”€ docs/
    â”œâ”€â”€ hooks-user-guide.md               â† ç”¨æˆ·æŒ‡å—
    â”œâ”€â”€ hooks-examples.md                 â† ç¤ºä¾‹åº“
    â””â”€â”€ hooks-implementation.md           â† å®ç°ç»†èŠ‚
```

## ğŸ”„ ä¾èµ–æµå‘

```
æœ€ç»ˆç”¨æˆ·
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CLI å‘½ä»¤è¡Œ        â”‚  VSCode UI æ’ä»¶       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¾èµ– core           â”‚  ä½¿ç”¨ core (import)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ import {            â”‚  import {            â”‚
â”‚   HookSystem,       â”‚    HookSystem,       â”‚
â”‚   HookEventHandler, â”‚    HookEventHandler, â”‚
â”‚   ...               â”‚    ...               â”‚
â”‚ } from core         â”‚  } from core         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“                    â†“
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  packages/core/src/hooks/  â”‚
      â”‚  â”œâ”€ types.ts               â”‚
      â”‚  â”œâ”€ hookRegistry.ts        â”‚
      â”‚  â”œâ”€ hookPlanner.ts         â”‚
      â”‚  â”œâ”€ hookRunner.ts          â”‚
      â”‚  â”œâ”€ hookAggregator.ts      â”‚
      â”‚  â”œâ”€ hookEventHandler.ts    â”‚
      â”‚  â”œâ”€ hookSystem.ts          â”‚
      â”‚  â””â”€ index.ts               â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
      11 ä¸ªå…³é”®äº‹ä»¶
      è¢«è§¦å‘å’Œæ‰§è¡Œ
           â†“
      ç”¨æˆ·çš„ Hook è„šæœ¬
      è¢«æ‰§è¡Œå’Œèšåˆ
           â†“
      å®‰å…¨æ§åˆ¶ã€å®¡è®¡ã€å®šåˆ¶
      ç­‰åŠŸèƒ½ç”Ÿæ•ˆ
```

## âœ¨ æ¶æ„ä¼˜åŠ¿

### 1. ä»£ç é‡ç”¨ - é›¶é‡å¤

```
ä¸ä½¿ç”¨è¿™ä¸ªæ¶æ„çš„æƒ…å†µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLI     â”‚  â”‚ VSCode UI    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚            â”‚
     â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
    Hook ä»£ç éœ€è¦
    åœ¨ä¸¤ä¸ªåœ°æ–¹å®ç°
    å¯¼è‡´é‡å¤ä»£ç 

ä½¿ç”¨è¿™ä¸ªæ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLI     â”‚  â”‚ VSCode UI    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚            â”‚
     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
            â”‚
        packages/core
        Hook ä»£ç 
        åªå®ç°ä¸€æ¬¡
        âœ… DRY åŸåˆ™
```

### 2. ç»Ÿä¸€å®‰å…¨ç­–ç•¥

```
ä¸€ä»½ .deepvcode/settings.json é…ç½®ï¼š

{
  "hooks": {
    "BeforeTool": [{
      "command": "bash ./hooks/security-gate.sh"
    }]
  }
}

â†“ å¯¹æ‰€æœ‰å®¢æˆ·ç«¯ç”Ÿæ•ˆ â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLI ç”¨æˆ·    â”‚      â”‚ VSCode UI ç”¨æˆ·   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ£€æŸ¥çº¦æŸ    â”‚      â”‚ æ£€æŸ¥çº¦æŸ         â”‚
â”‚ æ‰§è¡Œ Hooks  â”‚      â”‚ æ‰§è¡Œ Hooks       â”‚
â”‚ äº«å—ä¿æŠ¤    â”‚      â”‚ äº«å—ä¿æŠ¤         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ‰€æœ‰ç”¨æˆ·éƒ½å—ç›¸åŒçš„å®‰å…¨çº¦æŸï¼
```

### 3. ä¸€è‡´çš„ç”¨æˆ·ä½“éªŒ

```
æ— è®ºç”¨æˆ·é€‰æ‹©å“ªä¸ªå®¢æˆ·ç«¯ï¼š
- ç›¸åŒçš„ Hooks é…ç½®æ ¼å¼
- ç›¸åŒçš„äº‹ä»¶æ¨¡å‹ï¼ˆ11 ä¸ªäº‹ä»¶ï¼‰
- ç›¸åŒçš„è¾“å…¥/è¾“å‡ºæ ¼å¼
- ç›¸åŒçš„å®‰å…¨ç­–ç•¥

ç”¨æˆ·ä½“éªŒï¼š
CLI: dvcode â†’ äº«å— Hooks âœ…
VSCode: VSCode æ’ä»¶ â†’ äº«å— Hooks âœ…
```

### 4. ç»´æŠ¤æˆæœ¬ä½

```
æ–°å¢ Hook åŠŸèƒ½æ—¶ï¼š

ä¿®æ”¹èŒƒå›´ï¼špackages/core/src/hooks/

å½±å“èŒƒå›´ï¼š
âœ… CLI è‡ªåŠ¨è·å¾—
âœ… VSCode UI è‡ªåŠ¨è·å¾—
âœ… æ— éœ€ä¿®æ”¹ä¸¤å¤„ä»£ç 

ç»´æŠ¤è´Ÿæ‹…ï¼šåªæœ‰ core
```

### 5. æ‰©å±•æ€§å¼º

```
å°†æ¥å¯èƒ½çš„æ–°å®¢æˆ·ç«¯ï¼š

packages/other-client/
  â”œâ”€â”€ ä¾èµ– core
  â””â”€â”€ è‡ªåŠ¨äº«å— Hooks!

ä¸éœ€è¦é‡æ–°å®ç° Hooksï¼Œ
æ–°å®¢æˆ·ç«¯å¼€ç®±å³ç”¨ï¼
```

## ğŸ”§ å®ç°ç»†èŠ‚

### Hooks åœ¨ Core ä¸­çš„ä½ç½®

```
packages/core/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ hooks/                  â† 5 å±‚æ¶æ„ï¼Œ2,800+ è¡Œä»£ç 
â”‚   â”‚   â”œâ”€â”€ types.ts            (ç±»å‹å®šä¹‰)
â”‚   â”‚   â”œâ”€â”€ hookRegistry.ts      (åŠ è½½éªŒè¯é…ç½®)
â”‚   â”‚   â”œâ”€â”€ hookPlanner.ts       (åŒ¹é…å’Œè§„åˆ’)
â”‚   â”‚   â”œâ”€â”€ hookRunner.ts        (æ‰§è¡Œè„šæœ¬)
â”‚   â”‚   â”œâ”€â”€ hookAggregator.ts    (ç»“æœèšåˆ)
â”‚   â”‚   â”œâ”€â”€ hookEventHandler.ts  (11 ä¸ªäº‹ä»¶)
â”‚   â”‚   â”œâ”€â”€ hookSystem.ts        (ç³»ç»Ÿåè°ƒ)
â”‚   â”‚   â””â”€â”€ index.ts             (å¯¼å‡ºæ‰€æœ‰å…¬å…± API)
â”‚   â”‚
â”‚   â”œâ”€â”€ config/config.ts         (Config ç±»æ›´æ–°)
â”‚   â”‚   â””â”€â”€ æ–°å¢ï¼š
â”‚   â”‚       - getHooks(): HooksConfig
â”‚   â”‚       - getExtensions(): ExtensionsConfig
â”‚   â”‚
â”‚   â””â”€â”€ utils/debugLogger.ts     (æ—¥å¿—å·¥å…·)
```

### Core çš„å¯¼å‡º

```typescript
// packages/core/src/hooks/index.ts

// å¯¼å‡ºæ‰€æœ‰ç±»å‹
export * from './types.js';

// å¯¼å‡ºæ ¸å¿ƒç»„ä»¶ï¼ˆ5 å±‚ï¼‰
export { HookSystem } from './hookSystem.js';
export { HookRegistry } from './hookRegistry.js';
export { HookRunner } from './hookRunner.js';
export { HookAggregator } from './hookAggregator.js';
export { HookPlanner } from './hookPlanner.js';
export { HookEventHandler } from './hookEventHandler.js';
```

### CLI å¦‚ä½•ä½¿ç”¨

```typescript
// packages/cli/src/services/hookService.ts (å‡è®¾ä½ç½®)

import {
  HookSystem,
  HookEventHandler,
  type HooksConfig
} from 'deepv-code-core';

// åˆå§‹åŒ– Hooks ç³»ç»Ÿ
const hookSystem = new HookSystem(config);

// ä½¿ç”¨ Hooks
await hookSystem.fireEvent('BeforeTool', toolInput);
```

### VSCode UI æ’ä»¶å¦‚ä½•ä½¿ç”¨

```typescript
// packages/vscode-ui-plugin/src/services/aiService.ts

import {
  HookSystem,
  HookEventHandler,
  type HooksConfig
} from 'deepv-code-core';

// åŒæ ·åˆå§‹åŒ–å’Œä½¿ç”¨
const hookSystem = new HookSystem(config);
await hookSystem.fireEvent('BeforeAgent', agentInput);
```

## ğŸ“Š å…±äº«èƒ½åŠ›æ€»ç»“

| èƒ½åŠ› | å®ç°ä½ç½® | CLI | VSCode UI | è¯´æ˜ |
|-----|--------|------|-----------|------|
| **HookSystem** | core | âœ… | âœ… | ç³»ç»Ÿåè°ƒå™¨ |
| **HookRegistry** | core | âœ… | âœ… | é…ç½®ç®¡ç† |
| **HookRunner** | core | âœ… | âœ… | è„šæœ¬æ‰§è¡Œ |
| **11 ä¸ªäº‹ä»¶** | core | âœ… | âœ… | äº‹ä»¶æ¨¡å‹ |
| **JSON æ ¼å¼** | core | âœ… | âœ… | è¾“å…¥è¾“å‡º |
| **è¶…æ—¶ç®¡ç†** | core | âœ… | âœ… | å­è¿›ç¨‹ä¿æŠ¤ |
| **é”™è¯¯å¤„ç†** | core | âœ… | âœ… | å®¹é”™æœºåˆ¶ |
| **å®¡è®¡æ—¥å¿—** | ç”¨æˆ·è„šæœ¬ | âœ… | âœ… | å¯é€‰åŠŸèƒ½ |
| **æƒé™æ§åˆ¶** | ç”¨æˆ·è„šæœ¬ | âœ… | âœ… | å¯é€‰åŠŸèƒ½ |

**æ‰€æœ‰èƒ½åŠ›éƒ½åœ¨ core å®ç°ï¼Œæ‰€ä»¥ CLI å’Œ VSCode UI éƒ½èƒ½äº«å—ï¼**

## ğŸ¯ é…ç½®ç»Ÿä¸€æ€§

```
ä½¿ç”¨åœºæ™¯ï¼šæŸå…¬å¸åŒæ—¶ä½¿ç”¨ CLI å’Œ VSCode UI æ’ä»¶

é…ç½®ç®¡ç†ï¼š
~/.deepv/settings.json (å…¨å±€é…ç½®)
  â”œâ”€â”€ Hooks é…ç½®
  â”œâ”€â”€ MCP é…ç½®
  â”œâ”€â”€ å‘½ä»¤é…ç½®
  â””â”€â”€ ...

.deepvcode/settings.json (é¡¹ç›®é…ç½®)
  â”œâ”€â”€ Hooks é…ç½® â† åŒä¸€ä¸ªï¼
  â”œâ”€â”€ MCP é…ç½®
  â”œâ”€â”€ å‘½ä»¤é…ç½®
  â””â”€â”€ ...

ç»“æœï¼š
âœ… CLI è¯»å–è¿™äº›é…ç½®ï¼Œäº«å— Hooks ä¿æŠ¤
âœ… VSCode UI è¯»å–åŒæ ·çš„é…ç½®ï¼Œäº«å— Hooks ä¿æŠ¤
âœ… ä¼ä¸šå®‰å…¨ç­–ç•¥ç»Ÿä¸€ç”Ÿæ•ˆ
âœ… æ— éœ€ç»´æŠ¤å¤šä»½é…ç½®
```

## ğŸ” å®‰å…¨æ¶æ„

```
ä¼ä¸šå®‰å…¨ç®¡ç†å‘˜
  â”‚
  â””â”€â†’ åˆ›å»º Hooks è„šæœ¬å’Œé…ç½®
      â”‚
      â”œâ”€â†’ .deepvcode/hooks/security-gate.sh
      â”œâ”€â†’ .deepvcode/hooks/audit-logger.sh
      â”œâ”€â†’ .deepvcode/hooks/rbac.sh
      â””â”€â†’ .deepvcode/settings.json
          â”‚
          â”œâ”€â†’ ä¸Šä¼ åˆ°é¡¹ç›® Git ä»“åº“
          â”‚
          â”œâ”€ æ‰€æœ‰å¼€å‘è€… Pull æœ€æ–°ä»£ç 
          â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                 â”‚
         é€šè¿‡ CLI å·¥ä½œ     é€šè¿‡ VSCode UI å·¥ä½œ
                 â”‚                 â”‚
         core åŠ è½½ Hooks    core åŠ è½½ Hooks
                 â”‚                 â”‚
         è‡ªåŠ¨äº«å—ä¿æŠ¤        è‡ªåŠ¨äº«å—ä¿æŠ¤
                 â”‚                 â”‚
         âœ… ç»Ÿä¸€å®‰å…¨ç­–ç•¥      âœ… ç»Ÿä¸€å®‰å…¨ç­–ç•¥
```

## ğŸ’¡ æœ€ä½³å®è·µ

### DOï¼šåˆ©ç”¨ Core çš„å…±äº«ç‰¹æ€§

```typescript
// å¥½ï¼šåœ¨ core ä¸­å®ç°ä¸€æ¬¡ï¼Œä¸¤ä¸ªå®¢æˆ·ç«¯è‡ªåŠ¨äº«å—
packages/core/src/hooks/myCustomHook.ts
  â†“
  â”œâ”€â”€ CLI è‡ªåŠ¨ä½¿ç”¨
  â””â”€â”€ VSCode UI è‡ªåŠ¨ä½¿ç”¨
```

### DON'Tï¼šé‡å¤å®ç°

```typescript
// ä¸å¥½ï¼šåœ¨ä¸¤ä¸ªåœ°æ–¹éƒ½å®ç°
packages/cli/src/hooks/... (âŒ é¿å…)
packages/vscode-ui-plugin/src/hooks/... (âŒ é¿å…)
```

### é…ç½®æ–‡ä»¶ä½ç½®

```
âœ… æ¨èï¼šå•ä¸€é…ç½®æ–‡ä»¶
.deepvcode/settings.json
  â””â”€ åŒæ—¶è¢« CLI å’Œ VSCode UI åŠ è½½

âŒ é¿å…ï¼šå¤šä»½é…ç½®
.deepvcode/cli-settings.json
.deepvcode/vscode-settings.json
  â””â”€ ç»´æŠ¤æˆæœ¬é«˜ï¼Œå®¹æ˜“ä¸ä¸€è‡´
```

## ğŸ“ˆ æ‰©å±•è·¯å¾„

å¦‚æœå°†æ¥éœ€è¦æ·»åŠ æ–°å®¢æˆ·ç«¯ï¼š

```
packages/new-client/
  â”œâ”€â”€ package.json
  â”‚   â””â”€â”€ dependencies: {
  â”‚       "deepv-code-core": "file:../core" â† ä¾èµ– core
  â”‚     }
  â”‚
  â”œâ”€â”€ src/
  â”‚   â”œâ”€â”€ main.ts
  â”‚   â””â”€â”€ services/
  â”‚       â””â”€â”€ hookService.ts
  â”‚           â””â”€â”€ import from 'deepv-code-core'
  â”‚
  â””â”€â”€ dist/

æ–°å®¢æˆ·ç«¯è‡ªåŠ¨äº«å—ï¼š
âœ… Hooks ç³»ç»Ÿ
âœ… æ‰€æœ‰ 11 ä¸ªäº‹ä»¶
âœ… å®Œæ•´çš„å®‰å…¨å’Œå®šåˆ¶èƒ½åŠ›
âœ… ç»Ÿä¸€é…ç½®ç®¡ç†

æ— éœ€é‡æ–°å®ç°ä»»ä½• Hooks ä»£ç ï¼
```

## ğŸ“ ç†è§£å…³é”®ç‚¹

### å…³é”®ç‚¹ 1ï¼šCore æ˜¯å…±äº«åº“

```
packages/core ä¸æ˜¯å¯æ‰§è¡Œç¨‹åºï¼Œè€Œæ˜¯ä¸€ä¸ª Node.js åº“ã€‚
å®ƒè¢« CLI å’Œ VSCode UI ä½œä¸ºä¾èµ–å¯¼å…¥ä½¿ç”¨ã€‚
```

### å…³é”®ç‚¹ 2ï¼šHooks åœ¨ Core ä¸­å®ç°

```
Hooks ç³»ç»Ÿï¼ˆHookSystemã€HookRegistryã€HookRunner ç­‰ï¼‰
åœ¨ packages/core ä¸­å®ç°ã€‚
è¿™ç¡®ä¿äº†æ‰€æœ‰ä½¿ç”¨ core çš„å®¢æˆ·ç«¯éƒ½èƒ½ä½¿ç”¨ Hooksã€‚
```

### å…³é”®ç‚¹ 3ï¼šä¸€ä»½é…ç½®ï¼Œå¤šä¸ªå®¢æˆ·ç«¯

```
.deepvcode/settings.json ä¸­çš„ Hooks é…ç½®
è¢« CLI åŠ è½½æ—¶ï¼šäº«å— Hooks ä¿æŠ¤
è¢« VSCode UI åŠ è½½æ—¶ï¼šä¹Ÿäº«å— Hooks ä¿æŠ¤
```

### å…³é”®ç‚¹ 4ï¼šæ— éœ€é¢å¤–å·¥ä½œ

```
CLI å¼€å‘è€…ï¼šåªéœ€åœ¨ CLI ä¸­å¯¼å…¥å’Œä½¿ç”¨ core çš„ Hooks
VSCode UI å¼€å‘è€…ï¼šåªéœ€åœ¨æ’ä»¶ä¸­å¯¼å…¥å’Œä½¿ç”¨ core çš„ Hooks
æ–°å¢å®¢æˆ·ç«¯ï¼šåŒæ ·åªéœ€å¯¼å…¥å’Œä½¿ç”¨ï¼Œæ— éœ€é‡æ–°å®ç°
```

## ğŸ“ å¦‚ä½•åœ¨å®¢æˆ·ç«¯ä¸­é›†æˆ Hooks

### åœ¨ CLI ä¸­ï¼ˆå‡è®¾ä½ç½®ï¼‰

```typescript
// packages/cli/src/core/agent.ts

import { HookEventHandler } from 'deepv-code-core';

export class Agent {
  private hookHandler: HookEventHandler;

  async executeTool(toolName: string, input: any) {
    // è§¦å‘ BeforeTool äº‹ä»¶
    const beforeResult = await this.hookHandler.fireBeforeTool({
      tool_name: toolName,
      tool_input: input,
      // ... å…¶ä»–å­—æ®µ
    });

    if (beforeResult.decision === 'deny') {
      throw new Error(`Tool blocked: ${beforeResult.reason}`);
    }

    // æ‰§è¡Œå·¥å…·
    const result = await tool.execute(input);

    // è§¦å‘ AfterTool äº‹ä»¶
    await this.hookHandler.fireAfterTool({
      tool_name: toolName,
      tool_output: result,
      // ... å…¶ä»–å­—æ®µ
    });

    return result;
  }
}
```

### åœ¨ VSCode UI ä¸­

```typescript
// packages/vscode-ui-plugin/src/services/aiService.ts

import { HookEventHandler } from 'deepv-code-core';

export class AIService {
  private hookHandler: HookEventHandler;

  async sendPrompt(prompt: string) {
    // è§¦å‘ BeforeAgent äº‹ä»¶
    await this.hookHandler.fireBeforeAgent({
      prompt,
      // ... å…¶ä»–å­—æ®µ
    });

    // å‘é€æç¤ºç»™ LLM
    const response = await this.geminiClient.generateContent(prompt);

    // è§¦å‘ AfterAgent äº‹ä»¶
    await this.hookHandler.fireAfterAgent({
      response,
      // ... å…¶ä»–å­—æ®µ
    });

    return response;
  }
}
```

---

## æ€»ç»“

| æ–¹é¢ | æè¿° |
|-----|------|
| **å®ç°ä½ç½®** | `packages/core/src/hooks/` (2,800+ è¡Œ) |
| **å…±äº«æ–¹å¼** | Core æ˜¯åº“ï¼Œè¢« CLI å’Œ VSCode UI ä½œä¸ºä¾èµ–å¯¼å…¥ |
| **é…ç½®ä½ç½®** | `.deepvcode/settings.json` (å•ä¸€é…ç½®) |
| **äº«å—å®¢æˆ·ç«¯** | CLI âœ…ã€VSCode UI âœ…ã€æœªæ¥çš„æ–°å®¢æˆ·ç«¯ âœ… |
| **ä»£ç é‡ç”¨** | 100% - Hooks ä»£ç åªå®ç°ä¸€æ¬¡ |
| **ç»´æŠ¤æˆæœ¬** | æœ€ä½ - æ”¹ä¸€å¤„å½±å“æ‰€æœ‰å®¢æˆ·ç«¯ |
| **æ‰©å±•æ€§** | æœ€é«˜ - æ–°å®¢æˆ·ç«¯å¼€ç®±å³ç”¨ |

**è®¾è®¡ç†å¿µï¼šä¸€ä»½ä»£ç ï¼Œå¤šä¸ªå®¢æˆ·ç«¯ï¼Œç»Ÿä¸€ä½“éªŒï¼**

---

**ç‰ˆæœ¬**ï¼š1.0
**åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
**é‡ç‚¹**ï¼šç†è§£ä¸ºä»€ä¹ˆ Hooks åœ¨ coreï¼Œä»¥åŠå®ƒå¦‚ä½•è¢«æ‰€æœ‰å®¢æˆ·ç«¯è‡ªåŠ¨ç»§æ‰¿
