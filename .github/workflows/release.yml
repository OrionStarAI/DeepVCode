name: Build and Release

# 触发条件
on:
  # 手动触发
  workflow_dispatch:
    inputs:
      version:
        description: '版本号 (留空则使用 package.json 中的版本)'
        required: false
        type: string
      prerelease:
        description: '是否为预发布版本'
        required: false
        type: boolean
        default: false
      draft:
        description: '是否创建草稿 Release'
        required: false
        type: boolean
        default: false

  # 当推送 tag 时自动触发
  push:
    tags:
      - 'v*.*.*'

# 设置权限
permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. 设置 Node.js 环境
      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 3. 安装依赖
      - name: 📦 Install dependencies
        run: npm ci

      # 4. 运行测试（可选，如果测试太慢可以注释掉）
      - name: 🧪 Run tests
        run: npm run test
        continue-on-error: true

      # 5. 运行 lint 检查
      - name: 🔍 Lint check
        run: npm run lint
        continue-on-error: true

      # 6. 类型检查
      - name: 📝 Type check
        run: npm run typecheck
        continue-on-error: true

      # 7. 构建跨平台包（不自动递增版本号）
      - name: 🏗️ Build cross-platform package
        run: npm run pack:prod:ci
        env:
          NODE_ENV: production

      # 8. 获取版本号
      - name: 📌 Get version
        id: get_version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            VERSION=$(node -p "require('./package.json').version")
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          fi
          echo "Current version: $(cat $GITHUB_OUTPUT | grep VERSION)"

      # 9. 查找构建产物
      - name: 🔍 Find build artifacts
        id: find_artifacts
        run: |
          TGZ_FILE=$(ls deepv-code-*.tgz | head -n 1)
          if [ -z "$TGZ_FILE" ]; then
            echo "❌ No .tgz file found!"
            exit 1
          fi
          echo "TGZ_FILE=$TGZ_FILE" >> $GITHUB_OUTPUT
          echo "Found artifact: $TGZ_FILE"
          ls -lh $TGZ_FILE

      # 10. 提取 Git Tag 注释信息
      - name: 📝 Extract tag message
        id: tag_message
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            # 获取 annotated tag 的完整消息（去除第一行标题后的内容）
            TAG_MESSAGE=$(git tag -l --format='%(contents)' "$TAG_NAME")

            if [ -z "$TAG_MESSAGE" ]; then
              echo "TAG_MESSAGE=No release notes provided in tag message." >> $GITHUB_OUTPUT
            else
              # 使用多行输出格式
              echo "TAG_MESSAGE<<EOF" >> $GITHUB_OUTPUT
              echo "$TAG_MESSAGE" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi
          else
            echo "TAG_MESSAGE=Manually triggered release. No tag message available." >> $GITHUB_OUTPUT
          fi

      # 11. 生成 Release Notes
      - name: 📝 Generate Release Notes
        id: release_notes
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          TGZ_FILE="${{ steps.find_artifacts.outputs.TGZ_FILE }}"
          TAG_MESSAGE="${{ steps.tag_message.outputs.TAG_MESSAGE }}"

          cat > release_notes.md << 'EOF'
          ## 📦 DeepV Code v$VERSION

          ### ✨ What's Changed

          $TAG_MESSAGE

          ---

          ### 📥 Installation

          **Option 1: Install from npm (Recommended)**
          ```bash
          npm install -g deepv-code@$VERSION
          ```

          **Option 2: Install from this Release**
          ```bash
          # Download the .tgz file, then:
          npm install -g $TGZ_FILE
          ```

          **Option 3: Run directly from GitHub**
          ```bash
          npx deepv-code
          ```

          ### 📋 Build Information

          - **Built at**: BUILD_TIME
          - **Node.js**: NODE_VERSION
          - **npm**: NPM_VERSION
          - **Package size**: FILE_SIZE

          ### 📚 Documentation

          - [Documentation](https://github.com/OrionStarAI/DeepVCode#readme)
          - [Report Issues](https://github.com/OrionStarAI/DeepVCode/issues)
          EOF

          # 替换变量
          sed -i "s/\$VERSION/${VERSION}/g" release_notes.md
          sed -i "s/\$TGZ_FILE/${TGZ_FILE}/g" release_notes.md
          sed -i "s|\$TAG_MESSAGE|${TAG_MESSAGE}|g" release_notes.md
          sed -i "s/BUILD_TIME/$(date -u +"%Y-%m-%d %H:%M:%S UTC")/g" release_notes.md
          sed -i "s/NODE_VERSION/$(node --version)/g" release_notes.md
          sed -i "s/NPM_VERSION/$(npm --version)/g" release_notes.md
          sed -i "s/FILE_SIZE/$(ls -lh $TGZ_FILE | awk '{print $5}')/g" release_notes.md

          cat release_notes.md

      # 12. 创建 GitHub Release
      - name: 🚀 Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          name: DeepV Code v${{ steps.get_version.outputs.VERSION }}
          body_path: release_notes.md
          draft: ${{ inputs.draft || false }}
          prerelease: ${{ inputs.prerelease || false }}
          files: ${{ steps.find_artifacts.outputs.TGZ_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 13. 上传构建产物为 workflow artifact（方便下载测试）
      - name: 📤 Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deepv-code-v${{ steps.get_version.outputs.VERSION }}
          path: ${{ steps.find_artifacts.outputs.TGZ_FILE }}
          retention-days: 90
