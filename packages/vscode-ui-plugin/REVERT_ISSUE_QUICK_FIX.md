# ç‰ˆæœ¬å›é€€å¤±è´¥ - å¿«é€Ÿä¿®å¤æŒ‡å—

## ğŸ¯ é—®é¢˜

ç”¨æˆ·ç‚¹å‡»å›é€€æŒ‰é’®æ—¶å‡ºç°é”™è¯¯ï¼š
```
å›é€€å¤±è´¥: Version node not found for turn: user-{timestamp}-{random}
```

## âœ… ä¿®å¤æ¦‚è¿°

### å·²ä¿®å¤çš„é—®é¢˜
1. âœ… **å›é€€å¤„ç†å™¨è°ƒç”¨é”™è¯¯çš„æœåŠ¡** â†’ ç°åœ¨ä½¿ç”¨ `versionControlManager.revertToTurn()`
2. âœ… **é™çº§æ–¹æ¡ˆ** â†’ å¦‚æœç‰ˆæœ¬æ§åˆ¶å¤±è´¥ï¼Œè‡ªåŠ¨é™çº§åˆ°æ–‡ä»¶å¤‡ä»½æ¢å¤
3. âœ… **è¯Šæ–­èƒ½åŠ›** â†’ æ·»åŠ è¯¦ç»†æ—¥å¿—å’Œè¯Šæ–­å‘½ä»¤
4. âœ… **é”™è¯¯ä¿¡æ¯æ”¹è¿›** â†’ ç”¨æˆ·è·å¾—æ›´æœ‰å¸®åŠ©çš„é”™è¯¯æç¤º

### ä¿®æ”¹çš„æ–‡ä»¶
- `src/extension.ts` - ä¿®å¤å›é€€å¤„ç†å™¨ï¼Œæ·»åŠ è°ƒè¯•å‘½ä»¤
- `src/services/versionControlManager.ts` - æ”¹è¿›é”™è¯¯è¯Šæ–­å’Œæ—¥å¿—
- `src/services/versionControlService.ts` - å¢å¼ºç‰ˆæœ¬èŠ‚ç‚¹åˆ›å»ºçš„å¯è¿½è¸ªæ€§

## ğŸ“‹ æ–°å¢è¯Šæ–­å‘½ä»¤

### `deepv.debugVersionNodes`
æ˜¾ç¤ºå½“å‰ä¼šè¯çš„ç‰ˆæœ¬èŠ‚ç‚¹è¯Šæ–­ä¿¡æ¯

```
æ‰§è¡Œæ­¥éª¤ï¼š
1. æ‰“å¼€å‘½ä»¤é¢æ¿ (Cmd+Shift+P)
2. è¾“å…¥ "debugVersionNodes"
3. æŒ‰ Enter

æ˜¾ç¤ºå†…å®¹ï¼š
- ä¼šè¯ID
- å¯å›æ»šæ¶ˆæ¯æ•°é‡å’Œåˆ—è¡¨
- å®Œæ•´çš„ç‰ˆæœ¬æ—¶é—´çº¿
- æ¯ä¸ªèŠ‚ç‚¹çš„è¯¦ç»†ä¿¡æ¯
```

## ğŸ”§ å¦‚ä½•éªŒè¯ä¿®å¤

### 1. ç‰ˆæœ¬èŠ‚ç‚¹åˆ›å»ºæµ‹è¯•
```
1. æ‰“å¼€ VS Codeï¼Œå¯åŠ¨ DeepV Code
2. å‘é€æ¶ˆæ¯ï¼š
   "è¯·åˆ›å»ºä¸€ä¸ª test.js æ–‡ä»¶ï¼Œå†…å®¹ä¸º console.log('hello')"
3. ç­‰å¾… AI æ‰§è¡Œå®Œæ¯•
4. æŸ¥çœ‹è¾“å‡ºæ—¥å¿— (Ctrl+Shift+`) ä¸­çš„ä»¥ä¸‹å†…å®¹ï¼š
   âœ“ "Recording changes for turn: user-..."
   âœ“ "Computed X operations"
   âœ“ "applyOpsAsBatch COMPLETE"
   âœ“ "Created version node: node-..."
```

### 2. å›é€€åŠŸèƒ½æµ‹è¯•
```
1. æ–‡ä»¶è¢«åˆ›å»ºåï¼Œç‚¹å‡»æ¶ˆæ¯æ—çš„å›é€€æŒ‰é’®
2. æŸ¥çœ‹æ—¥å¿—ä¸­çš„ä»¥ä¸‹å†…å®¹ï¼š
   âœ“ "Reverting to message: user-..."
   âœ“ "Finding node for turnId: user-..."
   âœ“ "Found version node: node-..."
   âœ“ "Revert to turn completed"
   âœ“ "Revert completed successfully"
3. æ–‡ä»¶åº”è¯¥è¢«åˆ é™¤ï¼ˆæ¢å¤åˆ°åŸå§‹çŠ¶æ€ï¼‰
```

### 3. è¯Šæ–­åŠŸèƒ½æµ‹è¯•
```
1. æ‰§è¡Œ "deepv.debugVersionNodes" å‘½ä»¤
2. æ˜¾ç¤ºçš„è¯Šæ–­ä¿¡æ¯ä¸­åº”è¯¥åŒ…å«ï¼š
   - ä¼šè¯ID
   - å¯å›æ»šæ¶ˆæ¯åˆ—è¡¨ï¼ˆåº”åŒ…å«ä½ åˆšå‘é€çš„æ¶ˆæ¯ï¼‰
   - ç‰ˆæœ¬æ—¶é—´çº¿ï¼ˆåº”æ˜¾ç¤ºæ–°åˆ›å»ºçš„ç‰ˆæœ¬èŠ‚ç‚¹ï¼‰
```

## ğŸ“Š æ—¥å¿—å…³é”®è¯é€ŸæŸ¥

| æ—¥å¿—è¾“å‡º | å«ä¹‰ |
|---------|------|
| `recordAppliedChanges START` | å¼€å§‹è®°å½•ç‰ˆæœ¬ï¼ˆé¢„æœŸåº”è¯¥å‡ºç°ï¼‰|
| `Computed X operations` | ä»å·¥å…·è°ƒç”¨è®¡ç®—å‡ºçš„æ“ä½œæ•° |
| `applyOpsAsBatch COMPLETE` | ç‰ˆæœ¬èŠ‚ç‚¹åˆ›å»ºå®Œæˆ |
| `Found version node` | âœ… æ‰¾åˆ°ç‰ˆæœ¬èŠ‚ç‚¹ |
| `Version node not found` | âŒ æœªæ‰¾åˆ°èŠ‚ç‚¹ï¼ˆé—®é¢˜å‡ºç°ï¼‰ |
| `Available turnRefs` | æ‰€æœ‰å¯ç”¨çš„ç‰ˆæœ¬èŠ‚ç‚¹ |
| `attempting fallback` | ç‰ˆæœ¬æ§åˆ¶å¤±è´¥ï¼Œä½¿ç”¨å¤‡ä»½æ¢å¤ |
| `Revert completed successfully` | âœ… å›é€€æˆåŠŸ |

## ğŸ› å¦‚æœä»ç„¶å‡ºç°é—®é¢˜

### æ’æŸ¥æ­¥éª¤

1. **æ£€æŸ¥ç‰ˆæœ¬èŠ‚ç‚¹æ˜¯å¦è¢«åˆ›å»º**
   ```
   æ‰§è¡Œ deepv.debugVersionNodes å‘½ä»¤
   æŸ¥çœ‹ "å¯å›æ»šæ¶ˆæ¯" åˆ—è¡¨
   å¦‚æœä½ çš„æ¶ˆæ¯IDæ²¡æœ‰å‡ºç° â†’ ç‰ˆæœ¬èŠ‚ç‚¹æ²¡æœ‰è¢«åˆ›å»º
   ```

2. **æ£€æŸ¥æ—¥å¿—ä¸­çš„é”™è¯¯**
   ```
   æ‰“å¼€ VS Code è¾“å‡ºé¢æ¿
   é€‰æ‹© "DeepV Code" é¢‘é“
   æŸ¥æ‰¾ "Recording changes" ç›¸å…³æ—¥å¿—
   æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
   ```

3. **æ‰‹åŠ¨è¿è¡Œè¯Šæ–­**
   ```
   Cmd+Shift+P â†’ "deepv.debugVersionNodes"
   æŸ¥çœ‹è¿”å›çš„è¯Šæ–­ä¿¡æ¯ä¸­çš„ "Available turnRefs"
   ```

4. **éªŒè¯è½å›å¤‡ä»½**
   ```
   å¦‚æœè¯Šæ–­æ˜¾ç¤ºç‰ˆæœ¬èŠ‚ç‚¹å­˜åœ¨ï¼Œä½†å›é€€å¤±è´¥ï¼š
   - æ£€æŸ¥æ˜¯å¦è§¦å‘äº† "attempting fallback" æ—¥å¿—
   - è¿™æ„å‘³ç€ç‰ˆæœ¬æ§åˆ¶å¤±è´¥ä½†å¤‡ä»½æ¢å¤å¯èƒ½æˆåŠŸ
   ```

## ğŸ’¡ æ”¹è¿›åçš„æ¶æ„

```
ç”¨æˆ·ç‚¹å‡»å›é€€
    â†“
MessageBubble â†’ revert_to_message (åŒ…å« messageId)
    â†“
extension.ts:onRevertToMessage
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹æ¡ˆ1ï¼šç‰ˆæœ¬æ§åˆ¶ç®¡ç†å™¨ (ä¸»è·¯å¾„)      â”‚
â”‚ versionControlManager.revertToTurn() â”‚
â”‚   â†“                                 â”‚
â”‚   findNodeByTurnId(messageId)       â”‚
â”‚   â†“ æˆåŠŸæ‰¾åˆ°ç‰ˆæœ¬èŠ‚ç‚¹                â”‚
â”‚   æ‰§è¡Œæ–‡ä»¶å›é€€                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ å¤±è´¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹æ¡ˆ2ï¼šæ–‡ä»¶å¤‡ä»½æœåŠ¡ (é™çº§æ–¹æ¡ˆ)     â”‚
â”‚ cursorStyleRevertService.revert()    â”‚
â”‚   â†“                                 â”‚
â”‚   æ¢å¤æ–‡ä»¶å¤‡ä»½                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ç”¨æˆ·çœ‹åˆ° "âœ… å·²å›é€€æˆåŠŸ" æˆ–é”™è¯¯ä¿¡æ¯
```

## ğŸ” ç›¸å…³ä»£ç ä½ç½®

| åŠŸèƒ½ | æ–‡ä»¶ä½ç½® |
|------|---------|
| ç‰ˆæœ¬èŠ‚ç‚¹åˆ›å»º | `aiService.ts:recordVersionForCompletedToolsWithIds()` |
| ç‰ˆæœ¬èŠ‚ç‚¹æŸ¥è¯¢ | `versionControlManager.ts:findNodeByTurnId()` |
| å›é€€å¤„ç†å™¨ | `extension.ts:onRevertToMessage()` |
| æ–‡ä»¶å¤‡ä»½ | `cursorStyleRevertService.ts:backupBeforeAI()` |
| è¯Šæ–­å‘½ä»¤ | `extension.ts:deepv.debugVersionNodes` |

## ğŸ“ å‚è€ƒèµ„æº

- [ç‰ˆæœ¬å›é€€ä¿®å¤å®Œæ•´æ–‡æ¡£](./VERSION_REVERT_FIX.md)
- [Cursorå®˜æ–¹æ–‡æ¡£ - ç‰ˆæœ¬æ§åˆ¶](https://cursor.sh/)
- [DeepV Codeç‰ˆæœ¬æ§åˆ¶è®¾è®¡](../docs/version-control.md)
