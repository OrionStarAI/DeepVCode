# å¯è§†åŒ–æ€»ç»“ï¼šPreviewæ¨¡å‹æ£€æµ‹é—®é¢˜

## é—®é¢˜æ¦‚è§ˆ

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ  VSCodeæ’ä»¶ Previewæ¨¡å‹é‡å¤è°ƒç”¨æ£€æµ‹å¤±æ•ˆé—®é¢˜          â”ƒ
â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«
â”ƒ                                                        â”ƒ
â”ƒ  ç”¨æˆ·ä½¿ç”¨gemini-3-pro-previewæ—¶ï¼š                     â”ƒ
â”ƒ  - AIé‡å¤è°ƒç”¨åŒä¸€å·¥å…·ï¼ˆread_file, globç­‰ï¼‰           â”ƒ
â”ƒ  - âŒ åœ¨VSCodeä¸­ï¼šå¾ªç¯æœªè¢«æ£€æµ‹ï¼ˆæ¶ˆæ¯æœªæ˜¾ç¤ºï¼‰         â”ƒ
â”ƒ  - âœ… åœ¨CLIä¸­ï¼šå¾ªç¯è¢«æ­£ç¡®æ£€æµ‹å¹¶ä¸­æ­¢                   â”ƒ
â”ƒ                                                        â”ƒ
â”ƒ  åŸå› ï¼šVSCodeæ’ä»¶æœªå¤„ç†LoopDetectedäº‹ä»¶              â”ƒ
â”ƒ                                                        â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
```

---

## ç³»ç»Ÿæ¶æ„å¯¹æ¯”

### CLIï¼ˆâœ… å·¥ä½œæ­£å¸¸ï¼‰

```
User Request
    â†“
GeminiClient
    â”œâ”€ LoopDetectionServiceåˆå§‹åŒ– âœ…
    â”œâ”€ reset() â†’ æ£€æµ‹preview model âœ…
    â”œâ”€ addAndCheck() â†’ å·¥å…·è°ƒç”¨æ£€æŸ¥ âœ…
    â”œâ”€ yield LoopDetectedäº‹ä»¶ âœ…
    â†“
Main Loop
    â”œâ”€ æ¥æ”¶event
    â”œâ”€ if (type == LoopDetected) âœ…
    â”‚  â””â”€ åœæ­¢å¤„ç† & åé¦ˆç”¨æˆ· âœ…
    â””â”€ AIåœæ­¢ âœ…
```

### VSCodeæ’ä»¶ï¼ˆâŒ ç¼ºé™·ï¼‰

```
User Request
    â†“
AIService.processChatMessage()
    â†“
GeminiClient
    â”œâ”€ LoopDetectionServiceåˆå§‹åŒ– âœ…
    â”œâ”€ reset() â†’ æ£€æµ‹preview model âœ…
    â”œâ”€ addAndCheck() â†’ å·¥å…·è°ƒç”¨æ£€æŸ¥ âœ…
    â”œâ”€ yield LoopDetectedäº‹ä»¶ âœ…
    â†“
AIService.processGeminiStreamEvents()
    â”œâ”€ for await (event of stream) {
    â”œâ”€   switch (event.type) {
    â”œâ”€     case Content: ... âœ…
    â”œâ”€     case ToolCall: ... âœ…
    â”œâ”€     case Error: ... âœ…
    â”œâ”€     // âŒ ç¼ºå¤±: case LoopDetected:
    â”œâ”€   }
    â”œâ”€ }
    â†“
âŒ äº‹ä»¶è¢«å¿½ç•¥ï¼Œæµç»§ç»­è¿è¡Œ
    â†“
âŒ ç”¨æˆ·æ— é€šçŸ¥ï¼Œå¾ªç¯æœªä¸­æ­¢
```

---

## æ‰§è¡Œæµç¨‹æ—¶é—´çº¿

### é¢„è§ˆæ¨¡å‹é‡å¤è°ƒç”¨ read_file 4æ¬¡çš„æƒ…å†µ

```
æ—¶é—´    CoreåŒ…ï¼ˆCLIï¼‰                  VSCodeæ’ä»¶
â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T0      GeminiClientåˆå§‹åŒ–             âœ… ç›¸åŒ
        LoopDetectionService created

T1      sendMessageStream()å¼€å§‹        âœ… ç›¸åŒ
        loopDetector.reset()
        isPreviewModel = true âœ…

T2      Event #1: read_file(a.ts)
        toolNameCallCounts['read_file'] = 1
        1 < 4 â†’ continue                âœ… ç›¸åŒ

T3      Event #2: read_file(b.ts)
        toolNameCallCounts['read_file'] = 2
        2 < 4 â†’ continue                âœ… ç›¸åŒ

T4      Event #3: read_file(c.ts)
        toolNameCallCounts['read_file'] = 3
        3 < 4 â†’ continue                âœ… ç›¸åŒ

T5      Event #4: read_file(d.ts)
        toolNameCallCounts['read_file'] = 4
        4 >= 4 â†’ LOOP DETECTED! âœ…     âœ… æ£€æµ‹ç›¸åŒ

T6      yield LoopDetectedäº‹ä»¶         âœ… ç”Ÿæˆç›¸åŒ

T7      switch (event.type) {          for awaitå¾ªç¯
        case LoopDetected: âœ…          switch (event.type) {
          stopFlow()                      // âŒ æ— case!
          return                          äº‹ä»¶è¢«å¿½ç•¥
        }                               }

T8      âœ… æµåœæ­¢                      âŒ æµç»§ç»­
        âœ… ç”¨æˆ·çœ‹åˆ°æ¶ˆæ¯                âŒ ç”¨æˆ·æ— åé¦ˆ
        âœ… é—®é¢˜è§£å†³                    âŒ å¾ªç¯ç»§ç»­
```

---

## é¢„è§ˆæ¨¡å‹æ£€æµ‹æœºåˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æ¨¡å‹æ£€æµ‹ï¼ˆ/preview/i.test()ï¼‰                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  è¾“å…¥: "gemini-3-pro-preview"                          â”‚
â”‚  æ­£åˆ™: /preview/i                                       â”‚
â”‚  ç»“æœ: true â†’ isPreviewModel = true âœ…                 â”‚
â”‚                                                         â”‚
â”‚  è¾“å…¥: "gemini-2.0-flash"                              â”‚
â”‚  ç»“æœ: false â†’ isPreviewModel = false                  â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ä¸¤å±‚å·¥å…·è°ƒç”¨æ£€æµ‹                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  Layer 1: æ‰€æœ‰æ¨¡å‹ (ä¸€ç›´æœ‰æ•ˆ)                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                      â”‚
â”‚  æ£€æŸ¥: name + args å®Œå…¨ç›¸åŒ                             â”‚
â”‚  é˜ˆå€¼: 10æ¬¡                                             â”‚
â”‚  ä¾‹: read_file({path:'a.ts'}) Ã— 10                     â”‚
â”‚                                                         â”‚
â”‚  Layer 2: Previewæ¨¡å‹ (isPreviewModel=trueæ—¶)          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€               â”‚
â”‚  æ£€æŸ¥: name ä»… (å¿½ç•¥args)                              â”‚
â”‚  ç†ç”±: Previewå€¾å‘å‚æ•°å¾®è°ƒå¾ªç¯                          â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚  â”‚ å·¥å…·ç±»å‹     â”‚ é˜ˆå€¼     â”‚                           â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
â”‚  â”‚ read_file    â”‚ 4 (ä¸¥æ ¼) â”‚ â—„â”€â”€ Intensive            â”‚
â”‚  â”‚ read_many    â”‚ 4 (ä¸¥æ ¼) â”‚                          â”‚
â”‚  â”‚ glob         â”‚ 4 (ä¸¥æ ¼) â”‚                          â”‚
â”‚  â”‚ search_file  â”‚ 4 (ä¸¥æ ¼) â”‚                          â”‚
â”‚  â”‚ ls           â”‚ 4 (ä¸¥æ ¼) â”‚                          â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
â”‚  â”‚ å…¶ä»–å·¥å…·     â”‚ 5 (æ™®é€š) â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰ï¼ˆâŒ ç°çŠ¶ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Previewæ¨¡å‹åœ¨VSCodeä¸­çš„è¡Œä¸º               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  ç”¨æˆ·: è¯»æ–‡ä»¶1, 2, 3, 4, 5               â”‚
â”‚                                             â”‚
â”‚  AIååº”:                                  â”‚
â”‚  1. read_file(file1.ts)     â† Coreæ£€æµ‹   â”‚
â”‚  2. read_file(file2.ts)     â† Coreæ£€æµ‹   â”‚
â”‚  3. read_file(file3.ts)     â† Coreæ£€æµ‹   â”‚
â”‚  4. read_file(file4.ts)     â† è§¦å‘æ£€æµ‹! â”‚
â”‚  5. read_file(file5.ts)     â† âŒ ç»§ç»­!  â”‚
â”‚  6. read_file(file6.ts)     â† âŒ ç»§ç»­!  â”‚
â”‚  7. read_file(file7.ts)     â† âŒ ç»§ç»­!  â”‚
â”‚  ...                         â† æ— é™å¾ªç¯   â”‚
â”‚                                             â”‚
â”‚  ç»“æœ: ç”¨æˆ·å›°æƒ‘ï¼ŒAPIé…é¢æµªè´¹                â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¿®å¤åï¼ˆâœ… æœŸæœ›ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¿®å¤åçš„è¡Œä¸º                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  ç”¨æˆ·: è¯»æ–‡ä»¶1, 2, 3, 4, 5               â”‚
â”‚                                             â”‚
â”‚  AIååº”:                                  â”‚
â”‚  1. read_file(file1.ts)     â† æ£€æµ‹ok    â”‚
â”‚  2. read_file(file2.ts)     â† æ£€æµ‹ok    â”‚
â”‚  3. read_file(file3.ts)     â† æ£€æµ‹ok    â”‚
â”‚  4. read_file(file4.ts)     â† è§¦å‘!     â”‚
â”‚                                             â”‚
â”‚  [ç³»ç»Ÿåœæ­¢] âœ…                              â”‚
â”‚  ğŸ”´ é”™è¯¯æ¶ˆæ¯æ˜¾ç¤º:                          â”‚
â”‚  "Loop detected: The AI was calling the  â”‚
â”‚   same tool repeatedly. Try a different  â”‚
â”‚   approach or provide more context."     â”‚
â”‚                                             â”‚
â”‚  ç”¨æˆ·å¯ä»¥:                                â”‚
â”‚  â€¢ ç†è§£å‘ç”Ÿäº†ä»€ä¹ˆ                         â”‚
â”‚  â€¢ ä¿®æ”¹è¯·æ±‚æ–¹å¼                           â”‚
â”‚  â€¢ ä¿æŒAPIé…é¢                             â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä»£ç ä¿®å¤ä½ç½®å›¾

```
File: packages/vscode-ui-plugin/src/services/aiService.ts

1470 private async processGeminiStreamEvents(
1471   stream: AsyncIterable<ServerGeminiStreamEvent>,
1472   ...
1473 ): Promise<void> {
1474   for await (const event of stream) {
1475     switch (event.type) {
1476       case GeminiEventType.Content:
1477         // ... å¤„ç†
1478         break;
1479
1480       case GeminiEventType.Reasoning:
1481         // ... å¤„ç†
1482         break;
1483
1484       case GeminiEventType.ToolCallRequest:
1485         // ... å¤„ç†
1486         break;
1487
1488       case GeminiEventType.TokenUsage:
1489         // ... å¤„ç†
1490         break;
1491
1492       case GeminiEventType.Error:
1493         // ... å¤„ç†
1494         break;
1495
1496   â”Œâ”€ ã€æ·»åŠ è¿™é‡Œã€‘L1496-1510
1497   â”‚  case GeminiEventType.LoopDetected:
1498   â”‚    this.logger.warn(`ğŸ”´ Loop detected: ${event.value}`);
1499   â”‚    const msg = this.getLoopDetectionMessage(event.value);
1500   â”‚    await this.communicationService?.sendChatError(this.sessionId, msg);
1501   â”‚    this.isCurrentlyResponding = false;
1502   â”‚    this.setProcessingState(false, null, false);
1503   â”‚    await this.saveSessionHistoryIfAvailable();
1504   â”‚    return;  // âœ… å…³é”®ï¼
1505   â”‚    break;
1506   â””â”€
1507
1508       case GeminiEventType.Finished:
1509         // ... å¤„ç†
1510         break;
1511     }
1512   }
1513 }

1514  â”Œâ”€ ã€æ·»åŠ è¿™ä¸ªæ–°æ–¹æ³•ã€‘L1514-1535
1515  â”‚  private getLoopDetectionMessage(loopType: string | undefined): string {
1516  â”‚    switch (loopType) {
1517  â”‚      case 'consecutive_identical_tool_calls':
1518  â”‚        return 'ğŸ”´ Loop detected: ... (è¯¦è§å®ç°æŒ‡å—)';
1519  â”‚      case 'chanting_identical_sentences':
1520  â”‚        return 'ğŸ”´ Loop detected: ...';
1521  â”‚      case 'llm_detected_loop':
1522  â”‚        return 'ğŸ”´ Loop detected: ...';
1523  â”‚      default:
1524  â”‚        return 'ğŸ”´ Loop detected: ...';
1525  â”‚    }
1526  â”‚  }
1527  â””â”€
```

---

## é˜ˆå€¼å‚è€ƒè¡¨

### å·¥å…·è°ƒç”¨æ£€æµ‹é˜ˆå€¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  éé¢„è§ˆæ¨¡å‹ï¼ˆgemini-2.0-flashç­‰ï¼‰      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  æ‰€æœ‰å·¥å…·: name + argså®Œå…¨ç›¸åŒ          â”‚
â”‚  é˜ˆå€¼: 10æ¬¡                              â”‚
â”‚                                          â”‚
â”‚  ä¾‹:                                    â”‚
â”‚  read_file({path: 'a.ts'}) âœ“ 1         â”‚
â”‚  read_file({path: 'a.ts'}) âœ“ 2         â”‚
â”‚  ...                                    â”‚
â”‚  read_file({path: 'a.ts'}) âœ— 10 æ£€æµ‹!  â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é¢„è§ˆæ¨¡å‹ï¼ˆgemini-3-pro-previewç­‰ï¼‰     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  é«˜å¼€é”€å·¥å…· (read_file, globç­‰):        â”‚
â”‚  é˜ˆå€¼: 4æ¬¡ (ä»…æŒ‰name)                   â”‚
â”‚                                          â”‚
â”‚  ä¾‹:                                    â”‚
â”‚  read_file({path: 'a.ts'})   âœ“ 1       â”‚
â”‚  read_file({path: 'b.ts'})   âœ“ 2       â”‚
â”‚  read_file({path: 'c.ts'})   âœ“ 3       â”‚
â”‚  read_file({path: 'd.ts'})   âœ— 4 æ£€æµ‹!â”‚
â”‚                                          â”‚
â”‚  å…¶ä»–å·¥å…·:                              â”‚
â”‚  é˜ˆå€¼: 5æ¬¡ (ä»…æŒ‰name)                   â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ–‡ä»¶å…³ç³»å›¾

```
CoreåŒ…
â”œâ”€ src/services/
â”‚  â””â”€ loopDetectionService.ts (570+ è¡Œ)
â”‚     â”œâ”€ class LoopDetectionService âœ…
â”‚     â”œâ”€ reset()
â”‚     â”œâ”€ checkToolCallLoop()
â”‚     â”œâ”€ checkPreviewModelToolNameLoop()
â”‚     â””â”€ å…¶ä»–æ£€æµ‹æ–¹æ³•
â”‚
â”œâ”€ src/core/
â”‚  â”œâ”€ client.ts (919è¡Œ)
â”‚  â”‚  â”œâ”€ GeminiClient constructor (L93)
â”‚  â”‚  â”œâ”€ sendMessageStream() (L606, 617)
â”‚  â”‚  â””â”€ addLoopDetectionFeedbackToHistory() (L826+)
â”‚  â”‚
â”‚  â””â”€ turn.ts
â”‚     â””â”€ GeminiEventType enum (åŒ…å«LoopDetected)
â”‚
â””â”€ src/services/
   â””â”€ loopDetectionService.test.ts (400+ è¡Œ)
      â””â”€ Preview Modelæµ‹è¯•


VSCodeæ’ä»¶
â”œâ”€ src/services/
â”‚  â”œâ”€ aiService.ts (1930è¡Œ)
â”‚  â”‚  â”œâ”€ processChatMessage() (L1409)
â”‚  â”‚  â”œâ”€ processStreamingResponseWithParts() (L1435)
â”‚  â”‚  â”œâ”€ processGeminiStreamEvents() (L1469) âŒ éœ€è¦ä¿®å¤
â”‚  â”‚  â””â”€ [ç¼ºå¤±] getLoopDetectionMessage() âŒ éœ€è¦æ·»åŠ 
â”‚  â”‚
â”‚  â””â”€ sessionManager.ts
â”‚
â””â”€ src/types/
   â””â”€ messages.ts
      â””â”€ GeminiEventType (å·²å®šä¹‰âœ…)

ä¿®å¤éœ€è¦:
  â€¢ åœ¨aiService.tsçš„processGeminiStreamEvents()ä¸­æ·»åŠ case
  â€¢ æ·»åŠ getLoopDetectionMessage()æ–¹æ³•
  â€¢ æ·»åŠ ç›¸åº”æµ‹è¯•
```

---

## ä¿®å¤å¤æ‚åº¦è¯„ä¼°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ä¿®å¤å¤æ‚åº¦è¯„åˆ†                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  ä»£ç æ”¹åŠ¨:        â­ éå¸¸ç®€å•           â”‚
â”‚  (åªéœ€æ·»åŠ 1ä¸ªcase + 1ä¸ªæ–¹æ³•)           â”‚
â”‚                                         â”‚
â”‚  ä¾èµ–å…³ç³»:        â­ éå¸¸ç®€å•           â”‚
â”‚  (æ— æ–°ä¾èµ–)                            â”‚
â”‚                                         â”‚
â”‚  æµ‹è¯•è¦†ç›–:        â­â­ ç®€å•             â”‚
â”‚  (éœ€è¦3-4ä¸ªæµ‹è¯•åœºæ™¯)                  â”‚
â”‚                                         â”‚
â”‚  é›†æˆéªŒè¯:        â­â­ ç®€å•             â”‚
â”‚  (æ‰‹åŠ¨æµ‹è¯•é¢„è§ˆæ¨¡å‹å³å¯)               â”‚
â”‚                                         â”‚
â”‚  æ€»ä½“éš¾åº¦:        â­ æä½               â”‚
â”‚  é¢„è®¡å·¥æ—¶:        2å°æ—¶                 â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å½±å“èŒƒå›´

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      è°å—åˆ°å½±å“ï¼Ÿ            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                              â”‚
â”‚  ğŸ”´ å—å½±å“:                  â”‚
â”‚     â€¢ VSCodeç”¨æˆ·              â”‚
â”‚     â€¢ ä½¿ç”¨previewæ¨¡å‹çš„ç”¨æˆ·   â”‚
â”‚     â€¢ è§¦å‘å¾ªç¯çš„ä»»åŠ¡          â”‚
â”‚                              â”‚
â”‚  âœ… ä¸å—å½±å“:                â”‚
â”‚     â€¢ CLIç”¨æˆ·                 â”‚
â”‚     â€¢ ä½¿ç”¨æ ‡å‡†æ¨¡å‹çš„ç”¨æˆ·      â”‚
â”‚     â€¢ ä¸è§¦å‘å¾ªç¯çš„ä»»åŠ¡        â”‚
â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      å½±å“çš„ä¸¥é‡ç¨‹åº¦          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                              â”‚
â”‚  ç”¨æˆ·ä½“éªŒ:   ğŸ”´ é«˜           â”‚
â”‚  (å®Œå…¨æ— åé¦ˆ)                â”‚
â”‚                              â”‚
â”‚  APIæˆæœ¬:    ğŸ”´ é«˜           â”‚
â”‚  (å¯èƒ½æ— é™è°ƒç”¨)              â”‚
â”‚                              â”‚
â”‚  ç³»ç»Ÿé£é™©:   ğŸŸ¡ ä¸­           â”‚
â”‚  (èµ„æºè€—å°½)                  â”‚
â”‚                              â”‚
â”‚  ä¿®å¤ä¼˜å…ˆçº§: ğŸ”´ é«˜           â”‚
â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¿®å¤å‰ååŠŸèƒ½å¯¹æ¯”

```
åŠŸèƒ½                        ä¿®å¤å‰    ä¿®å¤å
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ£€æµ‹previewæ¨¡å‹             âœ…        âœ…
è·Ÿè¸ªå·¥å…·è°ƒç”¨                âœ…        âœ…
è¯†åˆ«å¾ªç¯                    âœ…        âœ…
äº§ç”ŸLoopDetectedäº‹ä»¶        âœ…        âœ…
å¤„ç†LoopDetectedäº‹ä»¶        âŒ        âœ…
åœæ­¢æµå¤„ç†                  âŒ        âœ…
æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯                âŒ        âœ…
ä¿å­˜ä¼šè¯çŠ¶æ€                âŒ        âœ…
ç”¨æˆ·é€šçŸ¥                    âŒ        âœ…
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç”¨æˆ·ä½“éªŒè¯„åˆ†                2/10      9/10
```

---

## æ€»ç»“

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ  é—®é¢˜:   LoopDetectedäº‹ä»¶å¤„ç†ç¼ºå¤±    â”ƒ
â”ƒ  ä½ç½®:   aiService.processGeminiStreamEvents() â”ƒ
â”ƒ  ä¿®å¤:   æ·»åŠ 1ä¸ªcase + 1ä¸ªæ–¹æ³•        â”ƒ
â”ƒ  å·¥æ—¶:   ~2å°æ—¶                       â”ƒ
â”ƒ  ä¼˜å…ˆçº§: ğŸ”´ é«˜                        â”ƒ
â”ƒ  å½±å“:   Core vs VSCodeä¸€è‡´æ€§        â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
```

