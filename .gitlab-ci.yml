stages:
  - release
  - release-vscode

# 只在符合 cli-release-vx.x.x 或 vscode-release-vx.x.x 的 tag时触发
workflow:
  rules:
    - if: '$CI_COMMIT_TAG =~ /^cli-release-v\d+\.\d+\.\d+$/'
    - if: '$CI_COMMIT_TAG =~ /^vscode-release-v\d+\.\d+\.\d+$/'

release:
  stage: release
  tags:
    - deepvcode-release
  image: node:20
  script:
    # 安装依赖
    - npm install
    # 提取版本号并更新 package.json
    - export NEW_VERSION=$(echo $CI_COMMIT_TAG | sed 's/^cli-release-v//')
    - npm version $NEW_VERSION --no-git-tag-version
    # 构建
    - npm run build
    # 打包（使用 ci 版本避免重复自增）
    - npm run pack:prod:ci
    # 写入 npm token 以便 publish
    - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
    # 发布到 npm
    - npm publish
  before_script:
    - rm -f .npmrc || true
  after_script:
    - rm -f .npmrc || true
  rules:
    - if: '$CI_COMMIT_TAG =~ /^cli-release-v\d+\.\d+\.\d+$/'

release-vscode:
  stage: release-vscode
  tags:
    - deepvcode-release
  image: node:20
  script:
    # 安装依赖 (monorepo 根目录)
    - npm install
    # 提取版本号
    - export NEW_VERSION=$(echo $CI_COMMIT_TAG | sed 's/^vscode-release-v//')
    # 更新插件版本号 (在子目录中执行)
    - cd packages/vscode-ui-plugin
    - npm version $NEW_VERSION --no-git-tag-version
    # 构建插件 (包含 webview)
    - npm run build
    # 生成离线安装包作为发布产物
    - npx @vscode/vsce package -o ../../deepv-code-vscode-$NEW_VERSION.vsix
    # 发布到 VS Code Marketplace
    - npx @vscode/vsce publish -p ${VSCE_TOKEN} --packagePath ../../deepv-code-vscode-$NEW_VERSION.vsix
    # 发布到 Open VSX Registry
    - npx ovsx publish -p ${OVSX_TOKEN} --packagePath ../../deepv-code-vscode-$NEW_VERSION.vsix
  artifacts:
    paths:
      - "*.vsix"
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_TAG =~ /^vscode-release-v\d+\.\d+\.\d+$/'