# ğŸ”„ Loop Detection æµç¨‹å›¾è¯¦è§£

## 1. ç†æƒ³æµç¨‹ vs å®é™…æµç¨‹

### ç†æƒ³æµç¨‹ï¼ˆè®¾è®¡æ„å›¾ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ç”¨æˆ·å‘é€ä¸€æ¡æ¶ˆæ¯             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               v
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  LoopDetectionService â”‚
    â”‚  reset(promptId)      â”‚
    â”‚  isPreviewModel=?     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 v
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ æ”¶åˆ°å·¥å…·è°ƒç”¨äº‹ä»¶  â”‚
         â”‚ addAndCheck()     â”‚
         â”‚ ç´¯ç§¯è®¡æ•°          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  v
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ è¶…è¿‡é˜ˆå€¼?            â”‚
        â”‚ è§¦å‘ LoopDetected   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ¯ ç‰¹ç‚¹: å•æ¬¡ reset(), æŒç»­ç´¯ç§¯è®¡æ•°
```

### å®é™…æµç¨‹ï¼ˆVSCode ä¸­å‘ç”Ÿï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ç”¨æˆ·å‘é€ä¸€æ¡æ¶ˆæ¯             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               v
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ sendMessageStream(        â”‚
    â”‚   prompt_id="ai-...-123"  â”‚
    â”‚ )                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ reset("ai-...-123") â† #1  â”‚
    â”‚ isPreviewModel = true?     â”‚
    â”‚ toolNameCallCounts.clear() â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             v
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ æ”¶åˆ°å·¥å…·è°ƒç”¨äº‹ä»¶ (5)  â”‚
    â”‚ addAndCheck() 5 æ¬¡    â”‚
    â”‚ toolNameCallCounts:   â”‚
    â”‚  read_file = 5        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             v
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 5 < 5 (threshold)?   â”‚
    â”‚ æœªè¾¾åˆ°é˜ˆå€¼           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             v
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ submitToolResultsToLLM()      â”‚
    â”‚ sendMessageStream(            â”‚
    â”‚   prompt_id="tool-...-124" â† âŒ æ–°ID!
    â”‚ )                            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ reset("tool-...-124") â† #2â”‚  ğŸ”´ çŠ¶æ€æ¸…é›¶!
    â”‚ isPreviewModel = false?    â”‚  ğŸ”´ è®¡æ•°é‡ç½®!
    â”‚ toolNameCallCounts.clear() â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             v
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ æ”¶åˆ°å·¥å…·è°ƒç”¨äº‹ä»¶ (3)  â”‚
    â”‚ addAndCheck() 3 æ¬¡    â”‚
    â”‚ toolNameCallCounts:   â”‚
    â”‚  read_file = 3  â† ä»0å¼€å§‹
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             v
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 3 < 4 (threshold)?   â”‚
    â”‚ æœªè¾¾åˆ°é˜ˆå€¼           â”‚
    â”‚ (5+3=8 è¢«åˆ†æ•£äº†)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ¯ ç‰¹ç‚¹: å¤šæ¬¡ reset(), è®¡æ•°è¢«æ¸…é›¶, æ— æ³•ç´¯ç§¯
```

---

## 2. é—®é¢˜åŸå› é“¾æ¡

```
é—®é¢˜é“¾æ¡åˆ†æ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

å±‚çº§ 1: ç°è±¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Preview æ¨¡å‹å¾ªç¯æ£€æµ‹å®Œå…¨å¤±æ•ˆ         â”‚
â”‚ (å³ä½¿ 8 æ¬¡ read_file è°ƒç”¨ä¹Ÿä¸æ£€æµ‹)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
å±‚çº§ 2: è¡¨ç°
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å·¥å…·è°ƒç”¨è®¡æ•°æ— æ³•ç´¯ç§¯                 â”‚
â”‚ isPreviewModel å¯èƒ½è¢«é‡ç½®ä¸º false   â”‚
â”‚ checkPreviewModelToolNameLoop()     â”‚
â”‚ å¯èƒ½ä¸è¢«è°ƒç”¨                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
å±‚çº§ 3: ç›´æ¥åŸå› 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ loopDetector.reset() è¢«å¤šæ¬¡è°ƒç”¨      â”‚
â”‚ toolNameCallCounts.clear() è¢«å¤šæ¬¡è°ƒç”¨â”‚
â”‚ çŠ¶æ€æ— æ³•ä¿æŒè·¨ sendMessageStream    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
å±‚çº§ 4: æ ¹æœ¬åŸå› 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¯ä¸ª sendMessageStream ä½¿ç”¨ä¸åŒçš„   â”‚
â”‚ prompt_id                           â”‚
â”‚ "ai-response-123"                   â”‚
â”‚ "tool-results-124" â† ä¸åŒ!          â”‚
â”‚ "continuation-125" â† åˆä¸åŒ!        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
å±‚çº§ 5: è®¾è®¡ç¼ºé™·
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LoopDetectionService å‡è®¾:          â”‚
â”‚ å•ä¸ª prompt = å•ä¸ª reset() è°ƒç”¨      â”‚
â”‚ å•ä¸ª prompt = ä¸€æ¬¡å®Œæ•´äº¤äº’           â”‚
â”‚                                     â”‚
â”‚ ä½† VSCode å®é™…æ˜¯:                   â”‚
â”‚ ä¸€æ¬¡äº¤äº’ = å¤šä¸ª sendMessageStream   â”‚
â”‚ å¤šä¸ª sendMessageStream =            â”‚
â”‚   å¤šä¸ª prompt_id =                  â”‚
â”‚   å¤šä¸ª reset() è°ƒç”¨                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. çŠ¶æ€æ¼”å˜æ—¶é—´çº¿

```
æ—¶é—´è½´: å•ä¸ªç”¨æˆ·æ¶ˆæ¯çš„å¤„ç†

T0: ç”¨æˆ·è¾“å…¥ "è¯·è¯»å–æ‰€æœ‰ .ts æ–‡ä»¶"
    çŠ¶æ€: { isPreviewModel: undefined, toolCount: {} }

T1: åˆå§‹åŒ–å¤„ç†
    â†’ processChatMessage()
    â†’ processStreamingResponseWithParts(prompt_id="ai-response-1")
    â†’ sendMessageStream(prompt_id="ai-response-1")

    çŠ¶æ€å˜åŒ–:
    â”Œâ”€ loopDetector.reset("ai-response-1")
    â”‚  â””â”€ const model = config.getModel()  // "gemini-3-pro-preview"?
    â”‚     â””â”€ isPreviewModel = true âœ“
    â”‚     â””â”€ toolNameCallCounts.clear()
    â”‚        çŠ¶æ€: { isPreviewModel: true, toolCount: {} }
    â””â”€ lastPromptId = "ai-response-1"

T2: é¦–ä¸ªå·¥å…·è°ƒç”¨ (read_file 1/5)
    â†’ GeminiClient.sendMessageStream() æ¥æ”¶ ToolCallRequest äº‹ä»¶
    â†’ loopDetector.addAndCheck(event)
    â†’ checkPreviewModelToolNameLoop()
    â†’ toolNameCallCounts['read_file'] = 1
    çŠ¶æ€: { isPreviewModel: true, toolCount: {read_file: 1} }

T3: ç¬¬äºŒä¸ªå·¥å…·è°ƒç”¨ (read_file 2/5)
    â†’ toolNameCallCounts['read_file'] = 2
    çŠ¶æ€: { isPreviewModel: true, toolCount: {read_file: 2} }

T4: ç¬¬ä¸‰ä¸ªå·¥å…·è°ƒç”¨ (read_file 3/5)
    â†’ toolNameCallCounts['read_file'] = 3
    çŠ¶æ€: { isPreviewModel: true, toolCount: {read_file: 3} }

T5: ç¬¬å››ä¸ªå·¥å…·è°ƒç”¨ (read_file 4/5)
    â†’ toolNameCallCounts['read_file'] = 4
    â†’ 4 >= 4? å¦ (éœ€è¦æ›´æ¸…æ™°çš„é˜ˆå€¼åˆ¤æ–­)
    çŠ¶æ€: { isPreviewModel: true, toolCount: {read_file: 4} }

T6: ç¬¬äº”ä¸ªå·¥å…·è°ƒç”¨ (read_file 5/5)
    â†’ toolNameCallCalls['read_file'] = 5
    çŠ¶æ€: { isPreviewModel: true, toolCount: {read_file: 5} }

T7: å·¥å…·æ‰§è¡Œå®Œæˆï¼Œè¿”å›ç»“æœ
    â†’ scheduleToolCalls()
    â†’ submitToolResultsToLLM()

    ğŸ”´ å…³é”®æ—¶åˆ»:
    â†’ sendMessageStream(prompt_id="tool-results-2") â† æ–° ID!
    â†’ if (lastPromptId="ai-response-1" !== prompt_id="tool-results-2") â†’ TRUE
       â””â”€ ğŸ”´ loopDetector.reset("tool-results-2")
          â””â”€ ğŸ”´ const model = config.getModel() // å¯èƒ½å˜åŒ–?
             â””â”€ ğŸ”´ isPreviewModel = ? (å¯èƒ½å˜ä¸º false)
             â””â”€ ğŸ”´ toolNameCallCounts.clear() â† è®¡æ•°å…¨éƒ¨ä¸¢å¤±!
                  çŠ¶æ€ä» {read_file: 5} â†’ {}

    â†’ lastPromptId = "tool-results-2"

    çŠ¶æ€: { isPreviewModel: false?, toolCount: {} } â† é‡ç½®!

T8: ç»§ç»­å¤„ç†ï¼Œå¯èƒ½å†æœ‰ 2-3 ä¸ªå·¥å…·è°ƒç”¨
    â†’ toolNameCallCounts['read_file'] = 1 â† ä» 0 å¼€å§‹é‡æ•°
    â†’ toolNameCallCounts['read_file'] = 2
    â†’ toolNameCallCounts['read_file'] = 3

    å³ä½¿ checkPreviewModelToolNameLoop() è¢«è°ƒç”¨:
    â”œâ”€ if (isPreviewModel = false) â†’ ä¸æ‰§è¡Œæ­¤å‡½æ•°
    â””â”€ è®¡æ•°åªåˆ° 3ï¼Œæ— æ³•è¾¾åˆ°é˜ˆå€¼ 4 æˆ– 5

    çŠ¶æ€: { isPreviewModel: false, toolCount: {read_file: 3} }

T9: å¤„ç†å®Œæˆ
    çŠ¶æ€: å¾ªç¯æ£€æµ‹å¤±è´¥ âŒ

    å®é™…å·¥å…·è°ƒç”¨: 5 + 3 = 8 æ¬¡ (å·²è¶…è¿‡ä»»ä½•é˜ˆå€¼!)
    æ£€æµ‹åˆ°çš„: 3 æ¬¡ (æœ€åä¸€æ®µ)
    å¾ªç¯æ£€æµ‹: âŒ å®Œå…¨å¤±æ•ˆ
```

---

## 4. prompt_id ç®¡ç†é—®é¢˜

```
prompt_id å˜åŒ–é“¾
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

åœºæ™¯: ä¸€ä¸ªç”¨æˆ·æ¶ˆæ¯å¼•å‘å¤šä¸ªå·¥å…·è°ƒç”¨å’Œç»“æœ

â”Œâ”€ åˆå§‹æ¶ˆæ¯å¤„ç†
â”‚  â”œâ”€ processChatMessage()
â”‚  â”‚  â””â”€ const responseId = "ai-response-${Date.now()}"
â”‚  â”‚     â””â”€ ä¾‹: "ai-response-1735000000123"
â”‚  â”‚
â”‚  â””â”€ processStreamingResponseWithParts(messageId, parts, responseId)
â”‚     â””â”€ const stream = geminiClient.sendMessageStream(
â”‚            parts,
â”‚            signal,
â”‚            prompt_id = responseId  â† "ai-response-1735000000123"
â”‚        )
â”‚
â”‚  âœ“ reset() è¢«è°ƒç”¨: 1 æ¬¡
â”‚  çŠ¶æ€: loopDetector.lastPromptId = "ai-response-1735000000123"
â”‚
â”œâ”€ å·¥å…·ç»“æœå¤„ç†
â”‚  â””â”€ submitToolResultsToLLM()
â”‚     â””â”€ const stream = geminiClient.sendMessageStream(
â”‚            toolResponseParts,
â”‚            signal,
â”‚            prompt_id = `tool-results-${Date.now()}` â† "tool-results-1735000000124"
â”‚        )
â”‚
â”‚  âŒ ä¸åŒçš„ prompt_id! reset() è¢«è°ƒç”¨: ç¬¬ 2 æ¬¡
â”‚  çŠ¶æ€å˜åŒ–: loopDetector.lastPromptId = "tool-results-1735000000124"
â”‚           è®¡æ•°è¢«æ¸…é›¶
â”‚
â”œâ”€ ç»§ç»­ç”Ÿæˆ (å¯é€‰)
â”‚  â””â”€ sendMessageStream å¯èƒ½å†æ¬¡è°ƒç”¨
â”‚     â””â”€ å¦ä¸€ä¸ªä¸åŒçš„ prompt_id
â”‚
â”‚  âŒ åˆä¸€æ¬¡ reset()

é—®é¢˜æ±‡æ€»:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T1: prompt_id = "ai-response-123"
    reset() â†’ è®¡æ•°: {read_file: 5}

T2: prompt_id = "tool-results-124" â† ä¸åŒ!
    reset() â†’ è®¡æ•°æ¸…é›¶: {}

T3: (å¦‚æœç»§ç»­)
    prompt_id = "continuation-125" â† åˆä¸åŒ!
    reset() â†’ è®¡æ•°æ¸…é›¶

ç»“æœ: å·¥å…·è°ƒç”¨åˆ†æ•£åœ¨ 3 ä¸ªä¸åŒçš„ reset å‘¨æœŸä¸­
    æ— æ³•ç´¯ç§¯é˜ˆå€¼æ£€æµ‹
```

---

## 5. ä¿®å¤åçš„æµç¨‹å¯¹æ¯”

### ä¿®å¤å‰

```
æ¶ˆæ¯ 1         å·¥å…·ç»“æœ         å·¥å…·ç»“æœ
send()        send()          send()
  â”‚             â”‚               â”‚
  â”œâ”€ reset()    â”œâ”€ reset()      â”œâ”€ reset()
  â”‚             â”‚               â”‚
  â””â”€ count: 5   â””â”€ count: 0     â””â”€ count: 2

æ€»è®¡: åˆ†æ•£çš„ 5, 0, 2 (æ— æ³•ç´¯ç§¯)
ç»“æœ: æ£€æµ‹å¤±è´¥ âŒ
```

### ä¿®å¤å (æ–¹æ¡ˆ A)

```
æ¶ˆæ¯ 1         å·¥å…·ç»“æœ         å·¥å…·ç»“æœ
send()        send()          send()
  â”‚             â”‚               â”‚
  â”œâ”€ reset()    â”œâ”€ skip          â”œâ”€ skip
  â”‚             â”‚                â”‚
  â””â”€ count: 5  â”œâ”€ count: 8       â””â”€ count: 10
                                   (åŒä¸€è®¡æ•°å™¨)

æ€»è®¡: è¿ç»­çš„ 5 â†’ 8 â†’ 10 (ç´¯ç§¯!)
ç»“æœ: æ£€æµ‹æˆåŠŸ âœ“

å…³é”®: ä½¿ç”¨ç›¸åŒçš„ prompt_id
      "user-message-123"
      è´¯ç©¿æ•´ä¸ªäº¤äº’
```

---

## 6. æ ¸å¿ƒç±»å…³ç³»å›¾

```
LoopDetectionService çŠ¶æ€ç®¡ç†
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   LoopDetectionService              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - promptId: string                  â”‚
â”‚ - isPreviewModel: boolean           â”‚
â”‚ - toolNameCallCounts:               â”‚
â”‚   Map<string, number>               â”‚
â”‚ - lastToolCallKey: string           â”‚
â”‚ - toolCallRepetitionCount: number   â”‚
â”‚ - streamContentHistory: string      â”‚
â”‚ - contentStats: Map<...>            â”‚
â”‚ - turnsInCurrentPrompt: number      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + reset(promptId)         â† é—®é¢˜!    â”‚
â”‚   - æ¸…ç©ºæ‰€æœ‰è®¡æ•°                    â”‚
â”‚   - é‡æ–°è®¾ç½® isPreviewModel         â”‚
â”‚                                     â”‚
â”‚ + addAndCheck(event)      âœ“         â”‚
â”‚   - è°ƒç”¨ checkToolCallLoop          â”‚
â”‚   - è°ƒç”¨ checkContentLoop           â”‚
â”‚   - è°ƒç”¨ checkForLoopWithLLM        â”‚
â”‚                                     â”‚
â”‚ + checkPreviewModelToolNameLoop()   â”‚
â”‚   - æ£€æŸ¥ isPreviewModel             â”‚
â”‚   - æ›´æ–° toolNameCallCounts         â”‚
â”‚   - è¿”å›æ˜¯å¦æ£€æµ‹åˆ°å¾ªç¯              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–³
           â”‚ è¢« reset() å½±å“
           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GeminiClient           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - lastPromptId: string  â”‚
â”‚ - loopDetector: LDS     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + sendMessageStream()   â”‚
â”‚   if (lastPromptId     â”‚
â”‚       !== prompt_id)   â”‚ â† é—®é¢˜ç‚¹
â”‚   {                     â”‚
â”‚     loopDetector.reset()â”‚ â† é¢‘ç¹è°ƒç”¨
â”‚     lastPromptId =      â”‚
â”‚       prompt_id         â”‚
â”‚   }                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–³
           â”‚
        â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ VSCode AIService    â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ - geminiClient: GC  â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ + processChatMsg()  â”‚
        â”‚   â†’ prompt_id: "ai-" â”‚
        â”‚                     â”‚
        â”‚ + submitToolResults â”‚
        â”‚   â†’ prompt_id:      â”‚
        â”‚     "tool-" â† ä¸åŒ!  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. ä¿®å¤æ–¹æ¡ˆå¯¹æ¯”

```
æ–¹æ¡ˆå¯¹æ¯”è¡¨
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    æ–¹æ¡ˆ         â”‚   éš¾åº¦       â”‚   æ•ˆæœ       â”‚  æ¨è    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ A: ç»Ÿä¸€ ID      â”‚ â­â­ ç®€å•    â”‚ â­â­â­ å®Œç¾  â”‚ âœ“ æ¨è   â”‚
â”‚   ä½¿ç”¨ç›¸åŒçš„    â”‚ æ”¹åŠ¨ç‚¹å°‘     â”‚ è§£å†³æ ¹æœ¬é—®é¢˜ â”‚          â”‚
â”‚   prompt_id     â”‚ é€»è¾‘æ¸…æ™°     â”‚ æ— å‰¯ä½œç”¨     â”‚          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ B: è·¨ ID ç´¯ç§¯   â”‚ â­â­â­ å¤æ‚  â”‚ â­â­ ä¸­ç­‰   â”‚ â–³ å¤‡é€‰   â”‚
â”‚   å…¨å±€è®¡æ•°      â”‚ æ”¹åŠ¨æ·±åº¦å¤§   â”‚ è§£å†³é—®é¢˜ä½†   â”‚          â”‚
â”‚   ä¸ä¾èµ– ID     â”‚ ç»´æŠ¤å›°éš¾     â”‚ ä¸ä¼˜é›…       â”‚          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ C: Preview ç‰¹æ®Š â”‚ â­ éå¸¸ç®€å•  â”‚ â­ ä¸å®Œç¾   â”‚ âœ— ä¸æ¨è â”‚
â”‚   æ¿€è¿›æ£€æµ‹      â”‚ æ”¹åŠ¨æœ€å°‘     â”‚ åªæ²»ç–—ç—‡çŠ¶   â”‚          â”‚
â”‚                 â”‚ å¿«é€Ÿè§æ•ˆ     â”‚ ä¸è§£å†³æ ¹æœ¬   â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ–¹æ¡ˆ A çš„ä¼˜åŠ¿:
1. âœ“ ç¬¦åˆåŸå§‹è®¾è®¡æ„å›¾
2. âœ“ ä¸éœ€è¦ä¿®æ”¹æ ¸å¿ƒ LoopDetectionService é€»è¾‘
3. âœ“ ä¸€æ¬¡ä¿®æ”¹æ°¸ä¹…å—ç›Š (ä¸æ˜¯ä¸´æ—¶æ–¹æ¡ˆ)
4. âœ“ æ¸…æ™°æ˜“ç»´æŠ¤

æ–¹æ¡ˆ A çš„æ”¹åŠ¨ç‚¹:
1. AIService: ç”Ÿæˆ sharedPromptId
2. AIService: ä¿å­˜ currentPromptId
3. AIService: submitToolResultsToLLM() ä½¿ç”¨ä¿å­˜çš„ ID
4. AIService: processEditMessageAndRegenerate() ä½¿ç”¨ä¿å­˜çš„ ID
5. AIService: æ¸…ç©º currentPromptId (å®Œæˆæ—¶)
```

---

## 8. å®ç°å…³é”®ä»£ç ç‰‡æ®µ

### é—®é¢˜ä»£ç 

```typescript
// é—®é¢˜ 1: æ¯æ¬¡éƒ½ç”Ÿæˆæ–° ID
async processChatMessage(message: ChatMessage) {
  const responseId = `ai-response-${Date.now()}`;  // âŒ æ–° ID
  await this.processStreamingResponseWithParts(message.id, parts, responseId);
}

// é—®é¢˜ 2: å·¥å…·ç»“æœåˆæ˜¯æ–° ID
async submitToolResultsToLLM(tools: VSCodeToolCall[]) {
  const stream = this.geminiClient.sendMessageStream(
    toolResponseParts,
    signal,
    `tool-results-${Date.now()}`  // âŒ åˆæ˜¯æ–° ID
  );
}
```

### ä¿®å¤ä»£ç 

```typescript
// è§£å†³ 1: ç”Ÿæˆç»Ÿä¸€ ID
async processChatMessage(message: ChatMessage) {
  const sharedPromptId = `user-message-${message.id}-${Date.now()}`;  // âœ“ å…±äº« ID
  this.currentPromptId = sharedPromptId;  // âœ“ ä¿å­˜

  const responseId = `ai-response-${Date.now()}`;
  await this.processStreamingResponseWithParts(
    sharedPromptId,  // âœ“ ä½¿ç”¨å…±äº« ID
    parts,
    responseId
  );
}

// è§£å†³ 2: å¤ç”¨ä¿å­˜çš„ ID
async submitToolResultsToLLM(tools: VSCodeToolCall[]) {
  const promptId = this.currentPromptId || `tool-${Date.now()}`;  // âœ“ å¤ç”¨

  const stream = this.geminiClient.sendMessageStream(
    toolResponseParts,
    signal,
    promptId  // âœ“ ä½¿ç”¨ç›¸åŒ ID
  );
}
```

---

**æ ¸å¿ƒæ€æƒ³**: ä¸€ä¸ªç”¨æˆ·äº¤äº’ = ä¸€ä¸ª prompt_id = ä¸€ä¸ªå®Œæ•´çš„å¾ªç¯æ£€æµ‹å‘¨æœŸ

